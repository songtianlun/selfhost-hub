{{ define "main" }}
<div class="container mx-auto py-10 px-4">
    <h1 class="text-4xl font-bold mb-6">
        {{ if eq .Site.Language.Lang "zh" }}
        自托管服务和工具目录
        {{ else }}
        Self-hosted Services and Tools Directory
        {{ end }}
    </h1>

    <p class="text-xl text-gray-600 dark:text-gray-400 mb-12">
        {{ if eq .Site.Language.Lang "zh" }}
        {{ .Site.Params.subtitle }}
        {{ else }}
        {{ .Site.Params.subtitleEn }}
        {{ end }}
    </p>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-4">
        <!-- 筛选状态 -->
        <div id="filter-status"
            class="col-span-1 lg:col-span-4 mb-6 p-4 bg-gray-100/30 dark:bg-gray-800/30 rounded-lg hidden">
            <div class="flex flex-wrap items-center gap-3 mb-3">
                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">
                    {{ if eq .Site.Language.Lang "zh" }}已选择筛选{{ else }}Selected Filters{{ end }}:
                </span>

                <div id="selected-category-display"
                    class="hidden flex items-center gap-1 pl-3 pr-2 py-1.5 border border-gray-300 dark:border-gray-700 rounded-md">
                    <span id="selected-category-text" class="text-xs font-medium"></span>
                    <button id="remove-category-btn"
                        class="ml-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 rounded-full"
                        aria-label="{{ if eq .Site.Language.Lang " zh" }}移除分类{{ else }}Remove category{{ end }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                                clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <div id="selected-tags-container">
                    <!-- 动态添加的选中标签将显示在此处 -->
                </div>

                <button id="clear-filters-btn"
                    class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">
                    {{ if eq .Site.Language.Lang "zh" }}清除所有筛选{{ else }}Clear all filters{{ end }}
                </button>
            </div>

            <div class="text-sm text-gray-500 dark:text-gray-400">
                <span id="results-count"></span>
            </div>
        </div>

        <!-- 侧边栏筛选器 -->
        <div class="lg:col-span-1 space-y-6">
            <!-- 分类筛选器 -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">
                        {{ if eq .Site.Language.Lang "zh" }}按分类筛选{{ else }}Filter by Category{{ end }}
                    </h3>
                </div>

                <div class="border border-gray-200 dark:border-gray-800 rounded-md">
                    <div x-data="{ expanded: true }" class="w-full">
                        <button @click="expanded = !expanded"
                            class="flex justify-between items-center w-full px-4 py-2 text-sm font-medium text-left border-b border-gray-200 dark:border-gray-800">
                            <span>{{ if eq .Site.Language.Lang "zh" }}分类{{ else }}Categories{{ end }}</span>
                            <svg :class="{'rotate-180': expanded}" class="w-5 h-5 transform transition-transform"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div x-show="expanded" class="p-4">
                            <div class="space-y-2 pl-2">
                                {{ $categories := slice }}
                                {{ if eq .Site.Language.Lang "zh" }}
                                {{ range (where .Site.RegularPages "Section" "services") }}
                                {{ with .Params.category }}
                                {{ $categories = $categories | append . }}
                                {{ end }}
                                {{ end }}
                                {{ else }}
                                {{ $englishPages := where .Site.RegularPages "Section" "services" }}
                                {{ range $englishPages }}
                                {{ with .Params.category }}
                                {{ $categories = $categories | append . }}
                                {{ end }}
                                {{ end }}
                                {{ end }}

                                {{ range (sort (uniq $categories)) }}
                                <div class="flex items-center space-x-2 py-1 cursor-pointer category-option"
                                    data-category="{{ . }}">
                                    <div
                                        class="h-4 w-4 rounded-full border border-gray-400 dark:border-gray-600 flex items-center justify-center category-radio">
                                        <div class="h-2 w-2 rounded-full bg-blue-500 hidden category-radio-dot"></div>
                                    </div>
                                    <span class="text-sm font-medium leading-none">{{ . }}</span>
                                </div>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 标签筛选器 -->
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold">
                        {{ if eq .Site.Language.Lang "zh" }}按标签筛选{{ else }}Filter by Tags{{ end }}
                    </h3>
                </div>

                <div class="border border-gray-200 dark:border-gray-800 rounded-md">
                    {{ $allTags := slice }}
                    {{ if eq .Site.Language.Lang "zh" }}
                    {{ range (where .Site.RegularPages "Section" "services") }}
                    {{ range .Params.tags }}
                    {{ $allTags = $allTags | append . }}
                    {{ end }}
                    {{ end }}
                    {{ else }}
                    {{ $englishPages := where .Site.RegularPages "Section" "services" }}
                    {{ range $englishPages }}
                    {{ range .Params.tags }}
                    {{ $allTags = $allTags | append . }}
                    {{ end }}
                    {{ end }}
                    {{ end }}

                    <!-- 初始化标签分组 -->
                    {{ $techTags := slice }}
                    {{ $usageTags := slice }}
                    {{ $mediaTags := slice }}
                    {{ $otherTags := slice }}

                    <!-- 对标签进行分类 -->
                    {{ range (sort (uniq $allTags)) }}
                    {{ $tag := . }}
                    {{ $isTech := or (in $tag "Docker") (in $tag "Python") (in $tag "PHP") (in $tag "Go") (in $tag
                    "JavaScript") (in $tag "C#") (in $tag "Rust") }}
                    {{ $isUsage := or (in $tag "存储") (in $tag "协作") (in $tag "生产力") (in $tag "自动化") (in $tag "监控") (in
                    $tag "安全") }}
                    {{ $isMedia := or (in $tag "视频") (in $tag "音乐") (in $tag "照片") (in $tag "文件") (in $tag "文档") }}

                    {{ if $isTech }}
                    {{ $techTags = $techTags | append $tag }}
                    {{ else if $isUsage }}
                    {{ $usageTags = $usageTags | append $tag }}
                    {{ else if $isMedia }}
                    {{ $mediaTags = $mediaTags | append $tag }}
                    {{ else }}
                    {{ $otherTags = $otherTags | append $tag }}
                    {{ end }}
                    {{ end }}

                    <!-- 创建标签组字典 -->
                    {{ $tagGroups := dict }}
                    {{ if eq .Site.Language.Lang "zh" }}
                    {{ $tagGroups = dict "技术" $techTags "用途" $usageTags "媒体类型" $mediaTags "其他" $otherTags }}
                    {{ else }}
                    {{ $tagGroups = dict "Technology" $techTags "Purpose" $usageTags "Media Type" $mediaTags "Others"
                    $otherTags }}
                    {{ end }}

                    <!-- 显示标签组 -->
                    {{ range $groupName, $tags := $tagGroups }}
                    {{ if gt (len $tags) 0 }}
                    <div x-data="{ expanded: false }" class="w-full">
                        <button @click="expanded = !expanded"
                            class="flex justify-between items-center w-full px-4 py-2 text-sm font-medium text-left border-b border-gray-200 dark:border-gray-800">
                            <span>{{ $groupName }}</span>
                            <svg :class="{'rotate-180': expanded}" class="w-5 h-5 transform transition-transform"
                                xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                    clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div x-show="expanded" class="p-4">
                            <div class="space-y-2 pl-2">
                                {{ range (sort $tags) }}
                                <div class="flex items-center space-x-2">
                                    <input type="checkbox" id="tag-{{ . }}"
                                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 tag-checkbox"
                                        data-tag="{{ . }}">
                                    <label for="tag-{{ . }}"
                                        class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer">
                                        {{ . }}
                                    </label>
                                </div>
                                {{ end }}
                            </div>
                        </div>
                    </div>
                    {{ end }}
                    {{ end }}
                </div>
            </div>
        </div>

        <!-- 服务列表 -->
        <div class="lg:col-span-3">
            <div id="services-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                {{ $services := slice }}
                {{ if eq .Site.Language.Lang "zh" }}
                {{ $services = where .Site.RegularPages "Section" "services" }}
                {{ else }}
                {{ $services = where .Site.RegularPages "Section" "services" }}
                {{ end }}

                {{ range $services }}
                <div class="service-card border border-gray-200 dark:border-gray-800 rounded-md overflow-hidden h-full flex flex-col"
                    data-category="{{ .Params.category }}" data-tags="{{ delimit .Params.tags " ," }}"
                    data-title="{{ .Title | lower }}">
                    <a href="{{ .RelPermalink }}" class="block h-full flex flex-col">
                        <div class="relative aspect-video overflow-hidden">
                            {{ if .Params.image }}
                            <img src="{{ .Params.image }}" alt="{{ .Title }}" class="object-cover w-full h-full" />
                            {{ else }}
                            <div class="flex items-center justify-center h-full bg-gray-100 dark:bg-gray-700">
                                <span class="text-gray-400 dark:text-gray-500">{{ i18n "noImage" }}</span>
                            </div>
                            {{ end }}
                        </div>

                        <div class="flex-1 flex flex-col p-4">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold">{{ .Title }}</h3>
                                <span
                                    class="ml-2 text-xs px-2 py-1 border border-gray-300 dark:border-gray-700 rounded-md">
                                    {{ .Params.category }}
                                </span>
                            </div>

                            <p class="text-gray-600 dark:text-gray-400 line-clamp-3 mb-4 flex-1">
                                {{ .Params.description }}
                            </p>

                            <div class="flex flex-wrap gap-2 mt-auto">
                                {{ range first 3 .Params.tags }}
                                <span
                                    class="inline-flex items-center rounded-md bg-gray-100 dark:bg-gray-800 px-2.5 py-0.5 text-xs font-medium text-gray-800 dark:text-gray-300">
                                    {{ . }}
                                </span>
                                {{ end }}
                                {{ if gt (len .Params.tags) 3 }}
                                <span class="text-xs text-gray-500 dark:text-gray-400">
                                    +{{ sub (len .Params.tags) 3 }}
                                </span>
                                {{ end }}
                            </div>
                        </div>

                        <div class="border-t border-gray-200 dark:border-gray-800 p-4 mt-auto">
                            <div
                                class="inline-flex items-center justify-center rounded-md bg-blue-600 hover:bg-blue-700 w-full px-4 py-2 text-sm font-medium text-white shadow">
                                {{ if eq $.Site.Language.Lang "zh" }}了解详情{{ else }}Learn More{{ end }}
                            </div>
                        </div>
                    </a>
                </div>
                {{ end }}
            </div>

            <!-- 无结果提示 -->
            <div id="no-results" class="hidden text-center py-8">
                <p class="text-xl font-medium text-gray-500 dark:text-gray-400">
                    {{ if eq .Site.Language.Lang "zh" }}未找到服务{{ else }}No services found{{ end }}
                </p>
                <p class="mt-2 text-gray-500 dark:text-gray-400">
                    {{ if eq .Site.Language.Lang "zh" }}
                    尝试减少筛选条件或清除筛选
                    {{ else }}
                    Try reducing your filters or clearing them
                    {{ end }}
                </p>
                <button id="clear-filters-btn2"
                    class="mt-4 inline-flex items-center justify-center rounded-md bg-blue-600 hover:bg-blue-700 px-4 py-2 text-sm font-medium text-white shadow">
                    {{ if eq .Site.Language.Lang "zh" }}清除所有筛选{{ else }}Clear all filters{{ end }}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // 获取DOM元素
        const servicesGrid = document.getElementById('services-grid');
        const serviceCards = document.querySelectorAll('.service-card');
        const noResults = document.getElementById('no-results');
        const categoryOptions = document.querySelectorAll('.category-option');
        const tagCheckboxes = document.querySelectorAll('.tag-checkbox');
        const filterStatus = document.getElementById('filter-status');
        const selectedCategoryDisplay = document.getElementById('selected-category-display');
        const selectedCategoryText = document.getElementById('selected-category-text');
        const removeCategoryBtn = document.getElementById('remove-category-btn');
        const selectedTagsContainer = document.getElementById('selected-tags-container');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const clearFiltersBtn2 = document.getElementById('clear-filters-btn2');
        const resultsCount = document.getElementById('results-count');

        // 状态变量
        let selectedCategory = '';
        let selectedTags = [];
        let totalCount = serviceCards.length;
        let currentLang = document.documentElement.lang || 'zh';

        // 初始化
        initFromURL();

        // 从URL初始化筛选条件
        function initFromURL() {
            const urlParams = new URLSearchParams(window.location.search);

            // 获取分类
            const categoryParam = urlParams.get('category');
            if (categoryParam) {
                selectedCategory = categoryParam;
                updateCategoryUI(selectedCategory);
            }

            // 获取标签
            const tagParams = urlParams.getAll('tags');
            if (tagParams.length > 0) {
                selectedTags = tagParams;
                updateTagsUI();
            }

            // 应用筛选
            if (selectedCategory || selectedTags.length > 0) {
                filterServices();
                updateFilterStatus();
            }
        }

        // 更新分类UI
        function updateCategoryUI(category) {
            // 清除所有选中状态
            categoryOptions.forEach(option => {
                const radio = option.querySelector('.category-radio');
                const dot = option.querySelector('.category-radio-dot');
                radio.classList.remove('border-blue-500');
                radio.classList.add('border-gray-400', 'dark:border-gray-600');
                dot.classList.add('hidden');
            });

            // 设置选中的分类
            if (category) {
                const selectedOption = document.querySelector(`.category-option[data-category="${category}"]`);
                if (selectedOption) {
                    const radio = selectedOption.querySelector('.category-radio');
                    const dot = selectedOption.querySelector('.category-radio-dot');
                    radio.classList.remove('border-gray-400', 'dark:border-gray-600');
                    radio.classList.add('border-blue-500');
                    dot.classList.remove('hidden');
                }
            }
        }

        // 更新标签UI
        function updateTagsUI() {
            // 更新复选框状态
            tagCheckboxes.forEach(checkbox => {
                const tag = checkbox.getAttribute('data-tag');
                checkbox.checked = selectedTags.includes(tag);
            });

            // 更新选中标签显示
            selectedTagsContainer.innerHTML = '';
            selectedTags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'flex items-center gap-1 pl-3 pr-2 py-1.5 bg-gray-200/50 dark:bg-gray-700/50 rounded-md';
                tagElement.innerHTML = `
                    <span class="text-xs font-medium">${tag}</span>
                    <button class="remove-tag-btn ml-1 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 rounded-full"
                        data-tag="${tag}" aria-label="${currentLang === 'zh' ? '移除标签' : 'Remove tag'} ${tag}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                selectedTagsContainer.appendChild(tagElement);

                // 添加移除标签事件
                const removeBtn = tagElement.querySelector('.remove-tag-btn');
                removeBtn.addEventListener('click', function () {
                    const tagToRemove = this.getAttribute('data-tag');
                    removeTag(tagToRemove);
                });
            });
        }

        // 更新筛选状态
        function updateFilterStatus() {
            const isFiltering = selectedCategory || selectedTags.length > 0;

            if (isFiltering) {
                filterStatus.classList.remove('hidden');

                // 更新分类显示
                if (selectedCategory) {
                    selectedCategoryText.textContent = selectedCategory;
                    selectedCategoryDisplay.classList.remove('hidden');
                } else {
                    selectedCategoryDisplay.classList.add('hidden');
                }

                // 更新标签已在updateTagsUI中处理
            } else {
                filterStatus.classList.add('hidden');
            }

            // 更新结果计数
            updateResultsCount();
        }

        // 更新结果计数
        function updateResultsCount() {
            const visibleCount = [...serviceCards].filter(card => !card.classList.contains('hidden')).length;

            if (currentLang === 'zh') {
                resultsCount.textContent = visibleCount === totalCount
                    ? `共 ${visibleCount} 个服务`
                    : `筛选出 ${visibleCount}/${totalCount} 个服务`;
            } else {
                resultsCount.textContent = visibleCount === totalCount
                    ? `Total: ${visibleCount} services`
                    : `Filtered: ${visibleCount} of ${totalCount} services`;
            }
        }

        // 筛选服务
        function filterServices() {
            let hasVisibleCards = false;

            serviceCards.forEach(card => {
                const cardCategory = card.getAttribute('data-category');
                const cardTags = (card.getAttribute('data-tags') || '').split(',');

                const matchesCategory = !selectedCategory || cardCategory === selectedCategory;
                const matchesTags = selectedTags.length === 0 || selectedTags.every(tag => cardTags.includes(tag));

                if (matchesCategory && matchesTags) {
                    card.classList.remove('hidden');
                    hasVisibleCards = true;
                } else {
                    card.classList.add('hidden');
                }
            });

            if (hasVisibleCards) {
                servicesGrid.classList.remove('hidden');
                noResults.classList.add('hidden');
            } else {
                servicesGrid.classList.add('hidden');
                noResults.classList.remove('hidden');
            }
        }

        // 更新URL参数
        function updateURLParams() {
            const urlParams = new URLSearchParams();

            if (selectedCategory) {
                urlParams.set('category', selectedCategory);
            }

            selectedTags.forEach(tag => {
                urlParams.append('tags', tag);
            });

            const newURL = window.location.pathname + (urlParams.toString() ? `?${urlParams.toString()}` : '');
            window.history.pushState({}, '', newURL);
        }

        // 移除标签
        function removeTag(tag) {
            selectedTags = selectedTags.filter(t => t !== tag);
            updateTagsUI();
            updateURLParams();
            filterServices();
            updateFilterStatus();
        }

        // 清除所有筛选
        function clearAllFilters() {
            selectedCategory = '';
            selectedTags = [];
            updateCategoryUI('');
            updateTagsUI();
            updateURLParams();
            filterServices();
            updateFilterStatus();
        }

        // 分类选项点击事件
        categoryOptions.forEach(option => {
            option.addEventListener('click', function () {
                const category = this.getAttribute('data-category');

                if (selectedCategory === category) {
                    // 取消选择当前分类
                    selectedCategory = '';
                } else {
                    // 选择新分类
                    selectedCategory = category;
                }

                updateCategoryUI(selectedCategory);
                updateURLParams();
                filterServices();
                updateFilterStatus();
            });
        });

        // 标签复选框更改事件
        tagCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const tag = this.getAttribute('data-tag');

                if (this.checked) {
                    // 添加标签
                    if (!selectedTags.includes(tag)) {
                        selectedTags.push(tag);
                    }
                } else {
                    // 移除标签
                    selectedTags = selectedTags.filter(t => t !== tag);
                }

                updateTagsUI();
                updateURLParams();
                filterServices();
                updateFilterStatus();
            });
        });

        // 移除分类按钮点击事件
        removeCategoryBtn.addEventListener('click', function () {
            selectedCategory = '';
            updateCategoryUI('');
            updateURLParams();
            filterServices();
            updateFilterStatus();
        });

        // 清除筛选按钮点击事件
        clearFiltersBtn.addEventListener('click', clearAllFilters);
        clearFiltersBtn2.addEventListener('click', clearAllFilters);
    });
</script>
{{ end }}