---
import Layout from '../../../../layouts/Layout.astro';
import ServiceCard from '../../../../components/ServiceCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const services = await getCollection('services', ({ id }) => {
    return id.startsWith('zh/');
  });

  // 获取所有可能的分类和标签组合
  const paths = new Set<string>();
  services.forEach(service => {
    service.data.tags.forEach(tagGroup => {
      paths.add(`/services/category/${encodeURIComponent(tagGroup.category)}`);
      tagGroup.items.forEach(tag => {
        paths.add(`/services/category/${encodeURIComponent(tagGroup.category)}/tag/${encodeURIComponent(tag)}`);
      });
    });
  });

  return Array.from(paths).map(path => ({
    params: {
      category: path.split('/')[3],
      tag: path.split('/')[5]
    }
  }));
}

// 获取当前选中的标签
const { category, tag } = Astro.params;
const selectedCategory = category ? decodeURIComponent(category) : null;
const selectedTag = tag ? decodeURIComponent(tag) : null;

// 获取所有服务内容
const services = await getCollection('services', ({ id }) => {
  return id.startsWith('zh/');
});

// 获取所有标签分组
const allTagGroups = services.reduce((groups, service) => {
  service.data.tags.forEach(tagGroup => {
    if (!groups[tagGroup.category]) {
      groups[tagGroup.category] = new Set();
    }
    tagGroup.items.forEach(tag => {
      groups[tagGroup.category].add(tag);
    });
  });
  return groups;
}, {} as Record<string, Set<string>>);

// 过滤服务
const filteredServices = services.filter(service => {
  if (!selectedTag && !selectedCategory) return true;
  
  return service.data.tags.some(tagGroup => {
    // 如果选择了分类，检查当前服务是否属于该分类
    if (selectedCategory && tagGroup.category !== selectedCategory) return false;
    // 如果选择了标签，检查当前服务是否包含该标签
    if (selectedTag && !tagGroup.items.includes(selectedTag)) return false;
    return true;
  });
});

// 生成标签链接
function getTagLink(category: string, tag?: string) {
  if (!tag) {
    return `/services/category/${encodeURIComponent(category)}`;
  }
  return `/services/category/${encodeURIComponent(category)}/tag/${encodeURIComponent(tag)}`;
}
---

<Layout title="服务列表 - SelfHost Hub" description="浏览所有可自托管的服务，找到最适合你的工具。">
  <div class="space-y-8">
    <div class="text-center">
      <h1 class="text-3xl font-bold text-gray-900 mb-4">服务列表</h1>
      <p class="text-lg text-gray-600">探索各种可自托管的工具和服务</p>
    </div>

    <div class="space-y-4">
      {Object.entries(allTagGroups).map(([category, tags]) => (
        <div class="flex flex-wrap gap-2">
          <span class="text-sm font-medium text-gray-500 px-2">{category}：</span>
          <a
            href={getTagLink(category)}
            class={`px-4 py-2 rounded-full text-sm font-medium ${
              selectedCategory === category && !selectedTag
                ? 'bg-blue-100 text-blue-800'
                : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
            }`}
          >
            全部
          </a>
          {Array.from(tags).map((tag) => (
            <a
              href={getTagLink(category, tag)}
              class={`px-4 py-2 rounded-full text-sm font-medium ${
                selectedTag === tag && selectedCategory === category
                  ? 'bg-blue-100 text-blue-800'
                  : 'bg-gray-100 text-gray-800 hover:bg-gray-200'
              }`}
            >
              {tag}
            </a>
          ))}
        </div>
      ))}
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {filteredServices.map((service) => (
        <ServiceCard
          title={service.data.title}
          description={service.data.description}
          tags={service.data.tags.flatMap(group => group.items)}
          url={`/services/${service.id.replace('zh/', '').replace('.md', '')}`}
        />
      ))}
    </div>
  </div>
</Layout> 